<template>
  <DxTagBox
    ref="recipients"
    @opened="onOpened"
    :read-only="readOnly"
    :data-source="resipientStore"
    :show-selection-controls="false"
    @valueChanged="setRecipient"
    :showClearButton="true"
    :value="recipients"
    :valueExpr="valueExpr"
    displayExpr="name"
    :searchEnabled="true"
    searchExpr="name"
    :paginate="true"
    :page-size="10"
    :deferRendering="true"
  >
    <DxValidator v-if="validatorGroup" :validation-group="validatorGroup">
      <DxRequiredRule :message="$t(messageRequired)" />
    </DxValidator>
    <template #item="{ data }">
      <div>
        <component :data="data" :is="listItemByType(data.recipientType)" />
      </div>
    </template>
  </DxTagBox>
</template>

<script>
import defaultType from "~/components/recipient/components/list-item/default.vue";
import employeeTypeComponent from "~/components/recipient/components/list-item/employee-type.vue";
import recipientType from "~/infrastructure/constants/resipientType.js";
import { DxValidator, DxRequiredRule } from "devextreme-vue/validator";

import dataApi from "~/static/dataApi";
import { DxTagBox } from "devextreme-vue";
import DataSource from "devextreme/data/data_source";
export default {
  components: {
    DxValidator,
    DxRequiredRule,
    DxTagBox,
    employeeTypeComponent,
    defaultType,
  },
  props: {
    recipients: { default: [] },
    messageRequired: {},
    validatorGroup: {},
    readOnly: {},
    valueExpr: {},
  },
  data() {
    return {
      needRepaint: false,
      dataSourceLoaded: this.valueExpr,
    };
  },
  computed: {
    resipientStore() {
      const dataSource = new DataSource({
        store: this.$dxStore({
          key: "id",
          loadUrl: dataApi.recipient.list,
        }),
        paginate: true,
        pageSize: 10,
        sort: [{ selector: "recipientType", desc: false }],
      });
      if (this.dataSourceLoaded) {
        return dataSource;
      }
      if (
        this.readOnly ||
        (this.recipients !== null && this.recipients.length > 0)
      ) {
        this.needRepaint = true;
        return this.recipients;
      }

      return dataSource;
    },
  },
  methods: {
    onOpened() {
        
      if (!this.dataSourceLoaded) {
      }
      this.dataSourceLoaded = true;
    },
    listItemByType(type) {
      switch (type) {
        case recipientType.Employee:
          return "employeeTypeComponent";
        default:
          return "defaultType";
      }
    },
    setRecipient(e) {
      this.$emit("setRecipients", e.value);
      if (this.needRepaint) {
        this.needRepaint = false;
        this.$refs["recipients"].instance.repaint();
      }
    },
  },
};
</script>

<style></style>
